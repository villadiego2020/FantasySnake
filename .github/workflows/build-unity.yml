name: Download Artifact

on:
  workflow_dispatch: # รันเองได้ด้วยมือ

jobs:
  download-artifact:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check GitHub CLI Version
        run: gh --version

      - name: Authenticate with GitHub CLI
        run: echo ${{ secrets.GH_PAT }} | gh auth login --with-token

      - name: Debug Artifact List
        run: gh api repos/${{ github.repository }}/actions/artifacts --jq '.artifacts'

      - name: Get Artifact ID
        run: |
          CLIENT_ID=$(gh api repos/${{ github.repository }}/actions/artifacts --jq '.artifacts[] | select(.name=="Build-Client") | .id')
          if [[ -z "$CLIENT_ID" ]]; then
            echo "❌ No artifact found with name 'Build-Client'"
            exit 1
          fi
          echo "✅ Found Artifact ID: $CLIENT_ID"
          echo "CLIENT_ID=$CLIENT_ID" >> $GITHUB_ENV

      - name: Download Artifact
        run: |
          gh api repos/${{ github.repository }}/actions/artifacts/$CLIENT_ID/zip --output Build-Client.zip
          echo "✅ Artifact Downloaded: Build-Client.zip"

      - name: Upload Artifact to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: Build-Client.zip
          token: ${{ secrets.GH_PAT }}
          tag_name: v1.0.0
          name: "Build-Client Release"
          body: "🚀 New Build Available!"
          draft: false
          prerelease: false
